<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Material Design</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="http://fonts.googleapis.com/earlyaccess/jejugothic.css">
    <style media="screen">
      /*  __ : child of a thing ,  -- : modifier on the thing */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Roboto', 'Jeju Gothic', sans-serif;
      }
      html, body, .page {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      button {
        background: none;
        border: none;
        cursor: pointer;
      }
      a{
        text-decoration: none;
        color: inherit;
      }

      .page {
        background-image: url(./asset/background.jpg);
        background-size: cover;
        background-position: 25% 50%;
      }

      .container {
        width: 100%;
        height: 100%;
      }

      .header {
        width: 100%;
        height: 64px;
        padding: 20px;
        font-size: 20px;
        line-height: 1;
        background: linear-gradient(rgba(0,0,0,0.4) 0%,rgba(0,0,0,0.2) 70%,rgba(0,0,0,0));

        transition: background 0.4s cubic-bezier(0,0,0.3,1) 0s;
      }

      .header__menu-toggle {
        width: 24px;
        height: 24px;
        font-size: 24px;
        float: left;
      }

      .header__title {
        width: auto;
        height: 24px;
        margin-left: 20px;
        float: left;
      }

      /* For Mobile */
      .content, .content.is-mobile {
        position: absolute;
        top: 45%;
        left: 0;
        width: 100%;
        height: auto;
        min-height: 240px;
        margin: 0 auto;
        background: #FAFAFA;
        box-shadow: 0 2px 4px 0 rgba(0,0,0,0.3);

        will-change: transform;
        transition: top 0.5s ease 0s;
      }

      /* For Desktop */
      .content.is-desktop{
        position: absolute;
        top: 0;
        right: 0;
        width: 30%;
        min-width: 320px;
        height: 100%;
        margin-right: 0;
      }
    </style>
  </head>
  <body>
    <div class="js-page page">
      <div class="container">
        <div class="js-header header">
          <button class="js-menu-show header__menu-toggle material-icons">menu</button>
          <div class="header__title">Material Designing</div>
        </div>
        <div class="js-content content">
          <!-- Content -->
        </div>
      </div>
    </div>
    <script src="./source/js/ajax-handler.js"></script>
    <script src="./source/js/side-nav.js"></script>
    <script type="text/javascript" role="AJAX Module">
      if ((location+'').includes('?logout')) {
        delCookie('all');
        location.replace('./');
      }

      function UserVerification() {
        if (getCookie('id') == '' || getCookie('pw') == '')
          return false;

        var cId = getCookie('id');
        var cPw = getCookie('pw');
        var xhttp = new XMLHttpRequest();

        xhttp.open("POST", "./_login.php?id="+cId+"&pw="+cPw, false);
        xhttp.send();
        var xhttp_r = xhttp.responseText;

        if (xhttp_r.includes('true'))
          return true;
        else if (xhttp_r.includes('new'))
          return 'new';
        else {
          console.log(xhttp_r+'/'+getCookie('id')+'/'+document.cookie);
          delCookie('all');
        }

        return false;
      }

      // for SideNav
      if (UserVerification() == 'new' || !UserVerification())
        document.querySelector('.js-logout').style.display = 'none';


      class AjaxLoggedIn {
        constructor() {
          this.xhttp = new XMLHttpRequest();
          this.ajaxSrc = "./ajax/logged-in.html";
          this.ajaxTarget = document.querySelector(".js-content");

          this.onLoadEvt();
        }

        onLoadEvt () {
          this.xhttp.open("POST", this.ajaxSrc, false);
          this.xhttp.send();
          this.textDoc = this.xhttp.responseText;

          this.ajaxTarget.innerHTML = this.textDoc;

          userInfo();
        }
      }


      function userInfo() {
        xhttp = new XMLHttpRequest();

        xhttp.open("POST", "./_user_info.php?id="+getCookie("id"), false);
        xhttp.send();
        console.log(xhttp.responseText);

        var user_info = xhttp.responseText.split(';');
        if (user_info[0] != '' && user_info[0] != 'master') {
          var party = (user_info[0]+'').split(',');
          if (party[0] == 'master')
            party.shift();
          for (var i = 0; i < party.length; i++)
            party[i] = ', '+party[i];
          user_info[0] = '';
          for (var i = 0; i < party.length; i++)
            user_info[0] += party[i];
        }
        user_info[2] = user_info[2].replace(/ /g,'').replace(/,/g,', ');
        var party_master = user_info[3];

        document.querySelector(".js-user").innerHTML = getCookie('id');
        document.querySelector(".js-party").innerHTML = user_info[0];
        document.querySelector(".js-time").innerHTML = user_info[1] == undefined || user_info[1] == '' ? '예매한 좌석이 없습니다.' : user_info[1]+'부';
        document.querySelector(".js-seat").innerHTML = user_info[2];
      }


      var loginStatus = UserVerification();


      function CrossFade (target) {
        document.querySelector(".js-content").innerHTML = '';
        AjaxContent('main-ticket_animation.html');
        document.querySelector(".js-header").classList.add('ticket');
        document.querySelector(".js-content").classList.add('ticket');
        document.querySelector(".js-content-button").classList.add('ticket');

        userInfo();
        setTimeout(function(){location.assign('./'+target)}, 600);
      }


      if (loginStatus == 'new'){
        new AjaxLoggedIn();
        var user_info = prompt('추후 티켓 발급을 위한 이름/연락처를 남겨주세요.', '');
        if (user_info == null)
          user_info = '입력되지 않음';

        var xhttp = new XMLHttpRequest();
        xhttp.open("POST", './_resister.php?id='+getCookie('id')+'&pw='+getCookie('pw')+'&info='+user_info, false);
        xhttp.send();
      }
      else if(loginStatus == true)
        new AjaxLoggedIn();
      else {
        AjaxContent('login.html');
        console.log('login false');
      }

    </script>
    <script src="./source/js/screen-sizing.js"></script>
    <script src="./source/js/login.js"></script>
  </body>
</html>
